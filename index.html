<!DOCTYPE html>
<html style="background-color: black;">
  <link rel="stylesheet" href="styles.css">
  <div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
    <p>s</p>s<p>
    <canvas id="canvas"></canvas>
    <p style="text-align: center; color:yellow">Drag and drop an NES rom!</p>
  </div>

  <script> 
const initCanvas=()=>{let t=document.getElementById("canvas"),e=t.getContext("2d");return t.width=256,t.height=240,e.fillStyle="green",[t,e]},initEmu=async()=>{let t=fetch("emu.wasm");return await WebAssembly.instantiateStreaming(t,{env:{js_grow:t=>0,js_assert:()=>{console.log("Assert")}}})},createNes=(t,e)=>{let{wasm_malloc:n,wasm_free:a,wasm_init_nes:r,sizeof_Nes:s,memory:i}=t.instance.exports,o=n(s),u=n(e.length),l=new Uint8Array(i.buffer,u,e.length);for(let t=0;t<e.length;t++)l[t]=e[t];console.log("Creating ROM with size: "+l.length),console.log(l[0]+" "+l[1]+" "+l[2]+" "+l[3]);let p=r(o,u);return console.log("Cartridge load return: "+p),a(u),p>0?(a(o),{ptr:0}):{ptr:o}},buttons={A:1,B:2,SELECT:4,START:8,UP:16,DOWN:32,LEFT:64,RIGHT:128};let dropHandler=t=>{};const dragOverHandler=t=>{t.preventDefault()},initDropHandler=t=>{let e={ptr:0};return dropHandler=(async n=>{n.preventDefault();let a=new Uint8Array(await new Promise((t,e)=>{let a=new FileReader;a.onload=(e=>t(a.result)),a.readAsArrayBuffer(n.dataTransfer.files[0])}));e.ptr=createNes(t,a).ptr}),e},initInput=()=>{let t={input1:0,input2:0};return window.addEventListener("keydown",e=>{switch(e.keyCode){case 13:t.input1|=buttons.START;break;case 16:t.input1|=buttons.SELECT;break;case 90:t.input1|=buttons.A;break;case 88:t.input1|=buttons.B;break;case 37:t.input1|=buttons.LEFT;break;case 38:t.input1|=buttons.UP;break;case 39:t.input1|=buttons.RIGHT;break;case 40:t.input1|=buttons.DOWN}},!0),window.addEventListener("keyup",e=>{switch(e.keyCode){case 13:t.input1&=~buttons.START;break;case 16:t.input1&=~buttons.SELECT;break;case 90:t.input1&=~buttons.A;break;case 88:t.input1&=~buttons.B;break;case 37:t.input1&=~buttons.LEFT;break;case 38:t.input1&=~buttons.UP;break;case 39:t.input1&=~buttons.RIGHT;break;case 40:t.input1&=~buttons.DOWN}},!0),t},initScreen=t=>{let{wasm_malloc:e}=t.instance.exports;return{ptr:e(184320)}},main=async()=>{let t=await initEmu(),[e,n]=initCanvas(),a=initInput(),r=initDropHandler(t);for(;0==r.ptr;)await new Promise(t=>setTimeout(t,100));let s=initScreen(t);for(;;)window.requestAnimationFrame(()=>{let{update_nes:e,memory:i}=t.instance.exports;e(r.ptr,a.input1,s.ptr);let o=new ImageData(256,240,{}),u=new Uint8Array(i.buffer,s.ptr,184320);for(let t=0,e=0;t<245760;t+=4,e+=3)o.data[t+0]=u[e+0],o.data[t+1]=u[e+1],o.data[t+2]=u[e+2],o.data[t+3]=255;n.putImageData(o,0,0)}),await new Promise(t=>setTimeout(t,17))};main();
  </script>
</html>